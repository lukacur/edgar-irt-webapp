<div class="p-3 shadow-md border border-slate-500/50">
    <h2 class="text-lg text-purple-600">Question whitelist definition</h2>
    <hr class="my-3">

    <div [formGroup]="nodeSelectionForm">
        <app-searchable-select
            labelText="Select a course"
    
            [multi]="false"
            [searchable]="true"
            [selectableItems]="(courses$ | async) ?? []"
    
            textKey="text"
            valueKey="course"
    
            [useObjectAsValue]="false"

            [control]="nodeSelectionForm.get('selectedCourse')!"
        ></app-searchable-select>

        <div
            class="shadow-md rounded-lg p-3 border border-slate-500/50"
            *ngIf="(nodeSelectionForm.get('selectedCourse')?.value ?? null) !== null">
            <app-searchable-select
                labelText="Select a previously defined exercise"
        
                [multi]="false"
                [searchable]="true"
                [selectableItems]="(exerciseDefinitions$ | async) ?? []"
        
                textKey="text"
                valueKey="exDefinition"
        
                [useObjectAsValue]="false"
    
                [control]="nodeSelectionForm.get('selectedExerciseDefinition')!"
            ></app-searchable-select>

            <div
                class="mt-3 mx-2"
                *ngIf="(nodeSelectionForm.get('selectedExerciseDefinition')?.value ?? null) === null"
            >
                <hr class="mb-3">

                <h2 class="text-purple-600">Define a new exercise</h2>

                <div>
                    <label class="text-sm">Exercise name</label>
                    <input
                        #newExerNameInput
                        type="text"
                        class="p-3 bg-white border border-slate-500/50 rounded w-full"
                    >
                </div>

                <div class="mt-3">
                    <button
                        mat-flat-button
                        color="primary"
                        (click)="defineNewExercise(newExerNameInput.value)"
                    >Define a new exercise</button>
                </div>

                <hr class="my-3">

                <h2 class="text-purple-600">Delete exercise definitions</h2>

                <div>
                    <app-searchable-select
                        labelText="Select a previously defined exercise"
                
                        [multi]="true"
                        [searchable]="true"
                        [selectableItems]="(exerciseDefinitions$ | async) ?? []"
                
                        textKey="text"
                        valueKey="exDefinition"
                
                        [useObjectAsValue]="false"
            
                        [control]="nodeSelectionForm.get('toRemoveExerciseDefinitions')!"
                    ></app-searchable-select>

                    <button
                        mat-flat-button
                        color="warn"

                        (click)="removeSelectedExerciseDefinitions()"

                        [disabled]="(nodeSelectionForm.get('toRemoveExerciseDefinitions')?.value ?? []).length === 0"
                    >Remove selected exercise definitions</button>
                </div>
            </div>
        </div>

        <div *ngIf="(nodeSelectionForm.get('selectedExerciseDefinition')?.value ?? null) !== null">
            <div>
                <hr class="my-3">
    
                <h3 class="text-purple-600">Whitelist course question nodes</h3>
                <hr class="mt-3">
                <app-searchable-select
                    labelText="Select question nodes to whitelist"
                    
                    [multi]="true"
                    [searchable]="true"
                    [selectableItems]="(selectableNodes$ | async) ?? []"
                    
                    textKey="text"
                    valueKey="node"
    
                    [useObjectAsValue]="false"
                    
                    [control]="nodeSelectionForm.get('selectedNodes')!"
                ></app-searchable-select>
    
                <button
                    type="button"
                    mat-raised-button
                    color="primary"
                    [disabled]="!nodeSelectionForm.dirty"
                    (click)="whitelistSelectedNodes()"
                >Confirm</button>
            </div>
    
            <hr class="my-3">
    
            <div class="mt-3">
                <h3 class="text-purple-600">Course whitelisted nodes</h3>
                <hr class="my-3">
                <div class="overflow-auto max-h-[560px]">
                    <table class="w-full p-3 text-center">
                        <thead>
                            <tr>
                                <th>
                                    <mat-checkbox
                                        color="primary"
                                        [indeterminate]="removalSelectionStatus() === 'indeterminate'"
                                        (change)="setRemovalSelectionToAllNodes($event.checked)"
                                        [checked]="removalSelectionStatus() === 'full'"
                                        [disabled]="numberOfWhitelistedNodes === 0"
                                    ></mat-checkbox>
                                </th>
                                <th class="text-center">ID</th>
                                <th class="text-center">(Node type) - Name</th>
                                <th class="text-center">Whitelisted on</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let node of (exerciseDefinitionWhitelistedNodes$ | async) ?? []">
                                <td>
                                    <mat-checkbox
                                        color="primary"
                                        [checked]="(this.nodeSelectionForm.get('toRemoveNodeIds')?.value ?? []).includes(node.id)"
                                        (change)="
                                            toggleNodeForRemoval(!$event.checked, node.id);
                                        "
                                    ></mat-checkbox>
                                </td>
                                <td class="text-center">{{ node.id }}</td>
                                <td class="text-center">({{ node.node_type_name }}) - {{ node.node_name }}</td>
                                <td class="text-center">{{ node.whitelisted_on| date:"dd. MM. yyyy. HH:mm:ss" }}</td>
                            </tr>
                            <tr *ngIf="numberOfWhitelistedNodes === 0">
                                <td
                                    class="py-2 text-gray-500/50"
                                    colspan="4"
                                >No whitelisted nodes</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
        
                <hr class="my-3">
        
                <button
                    class="mt-3"
                    type="button"
                    mat-flat-button
                    color="warn"
                    (click)="removeSelectedNodes()"
                    [disabled]="(nodeSelectionForm.get('toRemoveNodeIds')?.value ?? []).length === 0"
                >Remove selected nodes</button>
            </div>
        </div>
    </div>
</div>
